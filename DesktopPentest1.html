<!DOCTYPE html>
<html lang="en">
  <head>
    <meta property="og:title" content="Desktop Application Penetration Testing (1)">
    <meta property="og:description" content="Interesting engagement I recently went thoguht, which could be informative and inspiring.">
    <meta property="og:url" content="https://0x34ziz.github.io/DesktopPentest1.html">
    <meta property="og:image" content="https://0x34ziz.github.io/images/DesktopPentest1.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>0x34ziz</title>
    <meta name="Abdelaziz Elhawary" content="Penetration testing">
    <meta name="description" content="Desktop Application Penetration Testing (1)">
    <meta name="keywords" content="Desktop Pentest">
    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <!--Replace with your tailwind.css once created-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="32x32">
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="16x16">

  </head>
  <body class="bg-white font-sans leading-normal tracking-normal">
    <!-- code -><code style="font-size: 0.7em" class="bg-gray-900 rounded text-white break-words whitespace-pre-wrap p-1"></code>  -->
    <!--Nav-->
    <nav class="mt-0 w-full" style="background-color:#0000000d">
      <div class="container mx-auto flex items-center">
        <div class="flex w-1/2 pl-4 text-sm">
          <ul class="list-reset flex justify-between flex-1 md:flex-none items-center">
            <li class="mr-2">
              <a class="inline-block py-2 px-2 text-black no-underline hover:underline" href="index.html">Blogs</a>
            </li>
            <li class="mr-2">
              <a class="inline-block py-2 px-2 text-black no-underline hover:underline" href="/Notes.html">Notes</a>
            </li>
            <li class="mr-2">
              <a class="inline-block text-gray-600 no-underline hover:text-black hover:underline py-2 px-2" href="About.html">About</a>
            </li>
          </ul>
        </div>
        <div class="flex w-1/2 justify-end content-center">
          <a class="inline-block text-gray-500 no-underline hover:text-white hover:text-underline text-center h-10 p-2 md:h-auto md:p-4 avatar" data-tippy-content="#facebook_id" href="https://www.github.com/0x34ziz">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
            </svg>
          </a>
          <a class="inline-block text-gray-500 no-underline hover:text-white hover:text-underline text-center h-10 p-2 md:h-auto md:p-4 avatar" data-tippy-content="#facebook_id" href="https://www.twitter.com/0x34ziz">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-twitter" viewBox="0 0 16 16">
              <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" />
            </svg>
          </a>
          <a class="inline-block text-gray-500 no-underline hover:text-white hover:text-underline text-center h-10 p-2 md:h-auto md:p-4 avatar" data-tippy-content="#facebook_id" href="https://www.youtube.com/abdelazizelhawary">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-youtube" viewBox="0 0 16 16" id="IconChangeColor">
              <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z" id="mainIconPathAttribute" filter="url(#shadow)" stroke-width="0" stroke="#ffffff"></path>
              <filter id="shadow">
                <feDropShadow id="shadowValue" stdDeviation="0" dx="0" dy="0" flood-color="black"></feDropShadow>
              </filter>
              <filter id="shadow">
                <feDropShadow id="shadowValue" stdDeviation=".5" dx="0" dy="0" flood-color="black"></feDropShadow>
              </filter>
              <filter id="shadow">
                <feDropShadow id="shadowValue" stdDeviation=".5" dx="0" dy="0" flood-color="black"></feDropShadow>
              </filter>
              <filter id="shadow">
                <feDropShadow id="shadowValue" stdDeviation=".5" dx="0" dy="0" flood-color="black"></feDropShadow>
              </filter>
            </svg>
          </a>
          <a class="inline-block text-gray-500 no-underline hover:text-white hover:text-underline text-center h-10 p-2 md:h-auto md:p-4 avatar" data-tippy-content="#github_id" href="https://www.linkedin.com/in/abdelazizelhawary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16">
              <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z" />
            </svg>
          </a>
        </div>
      </div>
    </nav>
    <!--slide in nav-->
    <div id="header" class="bg-white fixed w-full z-10 top-0 hidden animated" style="opacity: .95;">
      <div class="bg-white">
        <div class="flex flex-wrap items-center justify-center h-full">
          <div style="height: 30px;" class="text-white font-extrabold">
            <a class="flex text-gray-900 no-underline hover:text-gray-900 hover:no-underline pl-2" href="#">
              <span class="block md:inline w-full md:w-auto md:pl-1 text-center"> Desktop Application Penetration Testing (1)</span>
            </a>
          </div>
        </div>
      </div>
      <!--Progress bar-->
      <div id="progress" class="h-1 bg-white shadow" style="background:linear-gradient(to right, #242424 var(--scroll), transparent 0);"></div>
    </div>
    <!--Title-->
    <div class="text-center pt-16 md:pt-32">
      <p class="text-sm md:text-base text-red-700 font-bold">8 May 2024 <span class="text-gray-900">
      </p>
      <h1 class="font-bold break-normal text-3xl md:text-5xl">Desktop Application<br>Penetration Testing (1)</h1>
    </div>
    <!--image-->
    <div class="container w-full max-w-6xl mx-auto bg-white bg-contain bg-no-repeat bg-center mt-8 rounded" style="background-image: url('/images/DesktopPentest1.png'); height: 75vh;"></div>
    <!--Container-->
    <div class="container max-w-9xl mx-auto -mt-32">
      <div class="mx-0 sm:mx-6">
        <div style="font-size: 1.4em;font-family: 'Times New Roman', serif;" class="bg-white w-full p-8 md:p-24 text-xl md:text-2xl text-gray-800 leading-normal" style="font-family:Georgia,serif;">
          <!--Post Content-->
          <!--Lead Para-->
          <p class="py-6">Hello everyone, in this blog I wanted to write to you about an interesting <a class="text-gray-800 hover:text-red-700 no-underline border-b-2 border-red-700" href="https://0x34ziz.github.io/#Desktop">Desktop Application Penetration testing</a>  engagement I went through in a big financial entity, which could be informative and inspiring.

          <p class="py-6">The application was well implemented with huge functionalities and privileges to manage a huge system, which seemed challenging at first.</p>
          <br>
          <p class="py-6">After some static analysis and dynamic walkthrough, some variables in the application source code are being assigned a value dynamically during runtime, so I needed to intercept the traffic, which was a very complicated journey after understanding the generic way of traffic encrypting that was well-implemented, another choice was to debug the application to check for these values while being assigned, but before consuming time in anti-debugging techniques, I decided to make a dump file for the memory and check what juicy info I would find there regarding these variables,<br>
            <br> </p>
          <div style="display: flex; justify-content: center; align-items: center;">
            <img style="height:400px;"  src="./images/DumpMemo.jpg" alt="Memory Dump Screenshot">
          </div>
            <br>
            and as expected - it’s common -, after extracting <a class="text-gray-800 hover:text-red-700 no-underline border-b-2 border-red-700" href="https://learn.microsoft.com/en-us/sysinternals/downloads/strings">strings</a> from it using microsoft utility, 
            <br>
            <br>
            <div style="display: flex; justify-content: center; align-items: center;">
              <code style="font-size: 0.7em" class="bg-gray-900 rounded text-white break-words whitespace-pre-wrap p-1">“.strings.exe .Organization.DMP | Out-File -FilePath .Orgnization.txt”</code>
    
            </div>
            <br>
            I found my login credentials in plain text, <br>
            <br>
          <div style="display: flex; justify-content: center; align-items: center;">
            <img style="height:200px;"  src="./images/ID&PW.jpg" alt="Plain Text Credentials in Memory">
          </div>
            <br>
            <br>
            that shed light on another thought in my head, finding my username and password in plain text could be an indication to find something else that should have been used during the login and authentication mechanism, <br><br>Exactly….,<br><br> I meant the Encryption Key of course.</p>
          <!-- <div style="display: flex; justify-content: center; align-items: center;"> -->
            <!-- <img style="height:300px; ;" src="/images/regForm.png" alt="Registration Form"> -->
          <!-- </div> -->
          <br>
          <p class="py-6"> I wasn’t sure, so I decided to re-read the dump file line by line in the authentication part around my login credentials. This analysis took some time, but it was worth it since I noticed that there’s a string value being called before the strings referring to authentication.<br>
            <div style="display: flex; justify-content: center; align-items: center;">
              <img style="height:200px;"  src="./images/Encryption Key.jpg" alt="Encryption Key Cached in Memory">
            </div><br>
            I suspected it could be the key, so I then returned to the static analysis, after reversing the application which was written in C# and searching this value in the source code, I found it hard coded inside one of the DLL files used for encryption.
            <br>
            <div><br></div>
            <div style="display: flex; justify-content: center; align-items: center;">
              <img style="height:400px;"  src="./images/KeyinDNSpy.jpg" alt="Encryption Key Hardcoded">
            </div>
          <!-- <div style="display: flex; justify-content: center; align-items: center;"> -->
            <!-- <code style="font-size: 0.7em" class="bg-gray-900 rounded text-white break-words whitespace-pre-wrap p-1">Thank you for registering. An admin will review your request</code> -->
          <!-- </div> -->
          <br>I recognized that I now have the key to the kingdom since I am somehow now sure that this encryption methodology and this DLL file with this key are used for the encryption during the authentication process.
          <!-- <span class="text-xl md:text-2xl mb-5" style="color: #cd0000;text-decoration: underline;"> How can we detect an XSS vulnerability when we can't see how the output is handled?</span> -->
          <br>
          <br>I took the encryption class written in this DLL file, with all its dependencies externally to my Kali Linux, and made a <code style="font-size: 0.7em" class="bg-gray-900 rounded text-white break-words whitespace-pre-wrap p-1">Decryptor.cs</code> file to implement my C# Decryptor for this algorithm, where I added some lines to handle my inputs "the encrypted values" and let the magic turn against the magician.<br>
          <!-- <span style="text-decoration: underline;">However, this approach introduces two issues:</span> -->
          
          <script src="https://gist.github.com/0x34ziz/57a605d5580db56e49927db10b895da3.js"></script>
          <hr>
          <br>
         
          <p class="py-6"> Then I used the <code style="font-size: 0.7em" class="bg-gray-900 rounded text-white break-words whitespace-pre-wrap p-1">mono-complete</code>  which is an <a class="text-gray-800 hover:text-red-700 no-underline border-b-2 border-red-700" href="https://www.mono-project.com/">open-source implementation of the .NET framework</a>. to convert the .cs file using <code style="font-size: 0.7em" class="bg-gray-900 rounded text-white break-words whitespace-pre-wrap p-1">mcs Decryptor.cs</code>  to executable file.exe and then able to execute it in Linux using <code style="font-size: 0.7em" class="bg-gray-900 rounded text-white break-words whitespace-pre-wrap p-1">mono Decryptor.exe </code>  </p>
        
          <div><br></div>
            <div style="display: flex; justify-content: center; align-items: center;">
              <img style="height:200px;"  src="./images/Decryptor.jpg" alt="My Decryptor.exe">
            </div>
          
          <br> Using this executable now I managed to decrypt any encrypted data found in memory, local storage, and hard-coded values, by which I reached a lot of juicy info.
          <br><br>
          After expanding the use of this script I decided to go further for a privilege escalation vector, <br><br>so I returned back to the static analysis searching for the connection methodology with the Database server to check if I could make use of my Decrytor, until I reached the Class responsible for Database Connection, which shows a part of a SQL query that Authenticates using a hardcoded id, but for the password, it's value is assigned dynamically during runtime to a variable named AdminPassword, so luckily I now have the ID for the Admin to the Database, but for the AdminPassword variable, I didn’t find any relatives to this password variable, so for an instance I could have skipped this to another vector...<br><br> but I remembered the Memory Dump file I used earlier, now I can re-search for this ID in memory and check for any near values being cached around, which could be the password such as my ID and PW as shown earlier,<br><br> I found the ID ! 
          <br>
          <div style="display: flex; justify-content: center; align-items: center;">
            <img style="height:250px;"  src="./images/AdminID.jpg" alt="Admin ID cached in Memory">
          </div>
          <br><br>but found more than one encrypted values around, and luckily found the same encryption key being called again, which confirmed my thoughts, that the database connection password is also being encrypted with the same key, I started extracting all these encrypted values and Decrypt them using my Decryptor until I found a value that could match a password format.<br>
          <br>
          I asked myself before heading straight to connect to the DataBase, why don't I check for these credentials in the Desktop Application itself, since it's a way common mistake that the employees sometimes use the same credentials for multiple accounts.<br><br> 
          I monitored the floor around me until the employees finished their work in their accounts in order not to interrupt their running tasks and functions.
          <br><br>
          After I waited until they had finished, I tried to log in using the values I collected but had a prompt telling, 
          <div style="display: flex; justify-content: center; align-items: center;">
            <code style="font-size: 0.7em" class="bg-gray-900 rounded text-white break-words whitespace-pre-wrap p-1">“This user is currently logged in”</code>
  
          </div>
          <br>I thought the employee didn't fall in that trap, especially since this prompt is a default prompt done even if you used a wrong password <span style="font-style: italic;color: #00000067;">- which leads to another vulnerability performing users enumeration, but this is not the scope of my blog for now - </span>.
          <br><br>
          I then heard an employee telling someone inside the IT group that she was currently managing something in the database, so I recognized that this was the user I found, the user is actually logged in!<br><br>that gave me another hope to retry later. <br><br>I waited until she logged out of her account, and retried to login, and this time I logged in successfully in the Desktop application with the Administrator Privilege!!,<br><br> and now I also have the Credentials for a full access to the database server  <span style="font-style: italic;color: #00000067;"> - which can easily lead us to RCE to the backend server, but this could be for another blog -</span>.
          <br><br>
<hr><br>
          <p class="text-2xl md:text-3xl mb-5">For now, I wanted to shed light on:</p>

          1- 	How important memory dump file analysis is.<br><br>
          2- 	Always Check for Encryption methodologies used in the Application.<br><br>
          3- 	The Idea of re-using the same algorithm without exhausting yourself in reversing the methodology, you will re-use the same methodology but just by referring to the decryption part of it.<br><br>
          4- 	Also be aware during making any privilege escalation vectors and keep aligned with penetration testing standards to just show a POC of the whole process without exposing more info than needed for your check.<br><br>
          5-  Finally, Having a challenging encrypted traffic with a challengeing communication protocol and challenging anti-debugging techniques don't mean you won't reach the highest impact. ;)<br>
          
         <br><hr><br>
         That was all and thank you for reaching here :D
          
        
          <!--/ Post Content-->
        </div>
        <!--Author-->
        <div style="height: auto;" class="flex w-full items-center font-sans p-8 md:p-15">
          <a href="/index.html">
            <img class="w-10 h-10 rounded-full mr-4" src="/images/Avatar.png" alt="Avatar of Author">
          </a>
          <div class="flex-1">
            <a href="/index.html">
              <p class="text-base font-bold text-base md:text-xl leading-none">Abdelaziz Elhawary</p>
            </a>
            <a href="/index.html">
              <p class="text-gray-600 text-xs md:text-base">Penetration Tester</p>
            </a>
          </div>
          <div class="justify-end">
            <a href="About.html" class="bg-transparent border border-gray-500 hover:border-black text-xs text-gray-500 hover:text-black font-bold py-2 px-4 rounded-full">About Me</a>
          </div>
        </div>
        <br>
        <br>
        <br>
        <br>
        <br>
        <!--/Author-->
      </div>
    </div>
    </div>
    <!--   Scroll Top Button  -->
    <button class="btn-toggle-round scroll-top js-scroll-top" type="button" title="Scroll to top">
      <svg class="progress-circle" width="100%" height="100%" viewBox="-1 -1 102 102">
        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
      </svg>
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-up" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="cuurentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <line x1="12" y1="5" x2="12" y2="19" />
        <line x1="18" y1="11" x2="12" y2="5" />
        <line x1="6" y1="11" x2="12" y2="5" />
      </svg>
    </button>


    <footer style="background-color: rgba(0, 0, 0, 0.067); color: rgb(0, 0, 0); padding: 1px 0; text-align: center;">
      <div style="max-width: 1200px; margin: 0 auto;">
        <p style="margin: 10px 0;">0x34ziz - Abdelaziz Elhawary | Cybersecurity Enigneer at CyShield</p>
      </div>
    </footer>

    
  </body>
  <script src="Javascript.js"></script>
</html>